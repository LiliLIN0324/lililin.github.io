import{r as o,j as e,P as F}from"./vendor-DaBF5ba5.js";import{L as E,M as R,a as $,P as V,b as v,c as q,C as T}from"./icons-w26BM2_p.js";import"./index-BsQlb2Xs.js";import"./maplibre-Dg0xXImo.js";const A=["rgba(141, 211, 199, 1)","rgba(196, 196, 111, 1)","rgba(190, 186, 218, 1)","rgba(251, 128, 114, 1)","rgba(128, 177, 211, 1)","rgba(253, 180, 98, 1)","rgba(179, 222, 105, 1)","rgba(252, 205, 229, 1)","rgba(217, 217, 217, 1)","rgba(188, 128, 189, 1)","rgba(204, 235, 197, 1)","rgba(255, 237, 111, 1)","rgba(255, 174, 185, 1)","rgba(174, 199, 232, 1)","rgba(152, 223, 138, 1)","rgba(255, 127, 14, 1)","rgba(255, 187, 120, 1)","rgba(44, 160, 44, 1)","rgba(214, 39, 40, 1)","rgba(255, 152, 150, 1)"],B=x=>A[x%A.length],G=[5,12,20,26],H=(x,s=!1)=>{const b=x.trim().split(`
`),n=b[0].split(","),d=n.indexOf("Date"),u=n.indexOf("Mean_Day"),g=n.indexOf("Mean_Night"),D=n.indexOf("P10_Day"),r=n.indexOf("P25_Day"),N=n.indexOf("P75_Day"),l=n.indexOf("P90_Day"),k=n.indexOf("P10_Night"),P=n.indexOf("P25_Night"),z=n.indexOf("P75_Night"),y=n.indexOf("P90_Night");if(d===-1||u===-1||g===-1)return console.error("CSV is missing required columns: Date / Mean_Day / Mean_Night"),[];const p=[];for(let w=1;w<b.length;w++){const c=b[w].split(","),h={date:Number(c[d]),meanDay:Number(c[u]),meanNight:Number(c[g])};s&&(D!==-1&&(h.P10Day=Number(c[D])),r!==-1&&(h.P25Day=Number(c[r])),N!==-1&&(h.P75Day=Number(c[N])),l!==-1&&(h.P90Day=Number(c[l])),k!==-1&&(h.P10Night=Number(c[k])),P!==-1&&(h.P25Night=Number(c[P])),z!==-1&&(h.P75Night=Number(c[z])),y!==-1&&(h.P90Night=Number(c[y]))),p.push(h)}return p},J=async(x,s=!1)=>{const b=[],n=[];for(let d=0;d<x;d++){const u=`K_${x}_Cluster${d}_3D_Data.csv`,g=`/data/K_${x}/${u}`,D=fetch(g).then(r=>r.ok?r.text():(console.warn(`File not found or unreachable: ${g}`),null)).then(r=>{if(!r)return;const N=H(r,s);N.length>0&&b.push({id:d,name:u.replace(".csv",""),data:N,color:B(d)})}).catch(r=>{console.warn(`Error loading cluster ${d}:`,r)});n.push(D)}return await Promise.all(n),b.sort((d,u)=>d.id-u.id)},Q=({clusters:x,selectedClusterId:s,selectedPointIndex:b,onClusterSelect:n,onReset:d,showAllAttributes:u})=>{const[g,D]=o.useState(0),[r,N]=o.useState(!0),[l,k]=o.useState(!1),[P,z]=o.useState([]),y=o.useRef({x:2.12,y:2.12,z:1.5}),p=o.useRef();o.useEffect(()=>{if(!r){p.current&&cancelAnimationFrame(p.current);return}const m=2.12,t=()=>{D(a=>{const f=a+.005;return y.current={x:m*Math.cos(f),y:m*Math.sin(f),z:1.5},f}),p.current=requestAnimationFrame(t)};return p.current=requestAnimationFrame(t),()=>{p.current&&cancelAnimationFrame(p.current)}},[r]);const w=o.useMemo(()=>{const m=[];if(x.forEach(t=>{const a=l?P.includes(t.id):s===t.id,f=l?P.length===0||P.includes(t.id):s===null||s===t.id,i=t.data.map(S=>S.date),j=t.data.map(S=>S.meanDay),K=t.data.map(S=>S.meanNight);m.push({type:"scatter3d",mode:"lines",name:t.name,meta:{clusterId:t.id},opacity:f?a?1:.6:.1,x:i,y:j,z:K,line:{color:t.color,width:a?6:3},customdata:t.data.map((S,_)=>({clusterId:t.id,pointIndex:_})),hovertemplate:`<b>${t.name}</b><br>Mean_Day: %{y:.2f}<br>Mean_Night: %{z:.2f}<br>Date: %{x}<extra></extra>`,showlegend:!0}),u&&[{yKey:"P10Day",zKey:"P10Night",name:"P10"},{yKey:"P25Day",zKey:"P25Night",name:"P25"},{yKey:"P75Day",zKey:"P75Night",name:"P75"},{yKey:"P90Day",zKey:"P90Night",name:"P90"}].forEach(_=>{const L=t.data.map(I=>I[_.yKey]??I.meanDay),O=t.data.map(I=>I[_.zKey]??I.meanNight);m.push({type:"scatter3d",mode:"lines",name:`${t.name} - ${_.name}`,meta:{clusterId:t.id},visible:f,x:i,y:L,z:O,line:{color:t.color,width:1.5},opacity:a?.8:.2,showlegend:!0,clickinfo:"skip"})})}),!l&&s!==null&&b!==null){const t=x.find(a=>a.id===s);if(t&&t.data[b]){const a=t.data[b];m.push({type:"scatter3d",mode:"markers",name:"Selected Point",x:[a.date],y:[a.meanDay],z:[a.meanNight],marker:{size:6,color:"white",line:{color:t.color,width:10},symbol:"circle"},showlegend:!0})}}return m},[x,s,b,u,l,P]),c=o.useMemo(()=>({xaxis:{title:{text:"Date",font:{color:"#ffffff",size:16}},backgroundcolor:"#000000",gridcolor:"#ffffffff",showbackground:!1,color:"#ffffff",titlefont:{color:"#ffffff"},tickfont:{color:"#ffffff"},zerolinecolor:"#ffffff",dtick:90},yaxis:{title:{text:"Mean_Day",font:{color:"#ffffff",size:16}},backgroundcolor:"#000000",gridcolor:"#ffffffff",showbackground:!1,color:"#ffffff",titlefont:{color:"#ffffff"},tickfont:{color:"#ffffff"},zerolinecolor:"#ffffff",range:[-7,9],dtick:2},zaxis:{title:{text:"Mean_Night",font:{color:"#ffffff",size:16}},backgroundcolor:"#000000",gridcolor:"#ffffffff",showbackground:!1,color:"#ffffff",titlefont:{color:"#ffffff"},tickfont:{color:"#ffffff"},zerolinecolor:"#ffffff",range:[-9,6],dtick:2},dragmode:"turntable",aspectmode:"cube",camera:{eye:r?{x:2.12*Math.cos(g),y:2.12*Math.sin(g),z:1.5}:{x:y.current.x,y:y.current.y,z:y.current.z},projection:{type:"perspective"}}}),[r,g]),h=o.useMemo(()=>({autosize:!0,showlegend:!0,paper_bgcolor:"#000000",plot_bgcolor:"#000000",margin:{l:0,r:0,b:0,t:0,pad:0},legend:{x:1.05,y:.9,xanchor:"right",yanchor:"top",bgcolor:"rgba(15, 15, 15, 0)",font:{size:14,color:"#ffffff"},orientation:"v"},uirevision:"true",scene:c}),[c]),M=o.useCallback(m=>{if(!m.points||m.points.length===0)return;N(!1);const a=m.points[0].customdata;a&&(l?z(f=>f.includes(a.clusterId)?f.filter(i=>i!==a.clusterId):[...f,a.clusterId]):n(a.clusterId,a.pointIndex))},[n,l]),C=m=>{const t=w[m.curveNumber];if(t&&t.meta&&t.meta.clusterId!==void 0){const a=t.meta.clusterId;l?z(f=>f.includes(a)?f.filter(i=>i!==a):[...f,a]):n(a,0)}return!1};return e.jsxs("div",{className:"absolute inset-0",children:[e.jsxs("div",{className:"absolute left-4 bottom-8 z-50 flex flex-col gap-2",children:[e.jsx("button",{onClick:()=>{k(!l),z([])},className:`flex items-center gap-2 px-4 py-2 rounded-lg shadow-md transition-all text-sm font-medium border border-white/10 ${l?"bg-blue-600 text-white":"bg-white text-black"}`,children:l?e.jsxs(e.Fragment,{children:[e.jsx(E,{size:16})," Mode: Multi"]}):e.jsxs(e.Fragment,{children:[e.jsx(R,{size:16})," Mode: Single"]})}),s!==null&&e.jsxs("button",{onClick:d,className:"flex items-center gap-2 bg-black text-white px-5 py-2 rounded-lg text-sm",children:[e.jsx($,{size:20})," Reset View"]}),e.jsx("button",{onClick:()=>N(!r),className:"flex items-center justify-center gap-2 bg-white text-black px-4 py-2 rounded-lg text-sm",children:r?e.jsxs(e.Fragment,{children:["Stop ",e.jsx(V,{size:16})]}):e.jsxs(e.Fragment,{children:["Play ",e.jsx(v,{size:16})]})})]}),e.jsx(F,{data:w,layout:h,style:{width:"100%",height:"100%"},onClick:M,onLegendClick:C,config:{displayModeBar:!0,displaylogo:!1}})]})},Z=({initialK:x=5,providedClusters:s,isEmbedded:b=!1})=>{const[n,d]=o.useState(x),[u,g]=o.useState(!!(s&&s.length)),[D,r]=o.useState([]),[N,l]=o.useState(s??[]),[k,P]=o.useState(!1),[z,y]=o.useState(null),[p,w]=o.useState(null),[c,h]=o.useState(null),[M,C]=o.useState(!1),m=u?N:D;o.useEffect(()=>{if(s&&s.length){l(s),g(!0);return}if(u)return;(async()=>{P(!0),y(null),r([]),a();try{const j=await J(n,M);j.length===0?y(`No data found for K=${n}.`):r(j)}catch(j){console.error(j),y("Failed to load data files.")}finally{P(!1)}})()},[n,u,s,M]),o.useEffect(()=>{s&&s.length?(l(s),g(!0)):(l([]),g(!1))},[s]);const t=(i,j)=>{w(i),h(j)},a=()=>{w(null),h(null)},f=i=>{d(i),g(!1)};return e.jsxs("div",{className:"absolute inset-0 bg-black overflow-hidden ",children:[!b&&e.jsx("div",{className:"absolute top-8 left-8 z-30 flex items-center gap-8 bg-gray-1000 text-white px-4 py-2 rounded-lg border border-gray-700 shadow-lg",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-bold",children:"Select K:"}),G.map(i=>e.jsx("button",{onClick:()=>f(i),className:`px-3 py-1 rounded font-medium transition-colors ${!u&&n===i?"bg-white text-black shadow":"bg-gray-1000 text-white hover:bg-gray-800"}`,children:i},i))]})}),k&&e.jsx("div",{className:"absolute inset-0 z-40 flex items-center justify-center bg-white backdrop-blur-sm",children:e.jsx(q,{className:"w-8 h-8 text-gray-600 animate-spin"})}),z&&!k&&e.jsxs("div",{className:"absolute top-20 left-10 z-50 bg-red-50 text-red-700 px-4 py-3 rounded-md border border-red-200 shadow-sm flex items-center gap-2",children:[e.jsx(T,{size:20}),e.jsx("p",{className:"text-sm",children:z})]}),e.jsx("div",{className:"absolute bottom-8 right-8 z-30",children:e.jsx("button",{onClick:()=>C(i=>!i),className:"px-4 py-2 bg-white text-black rounded-lg shadow hover:bg-gray-300 transition-colors text-sm flex items-center gap-2",children:M?e.jsx(e.Fragment,{children:" Show Mean Attributes"}):e.jsx(e.Fragment,{children:" Show All Attributes"})})}),e.jsx("div",{className:"absolute inset-0 ",children:e.jsx(Q,{clusters:m,showAllAttributes:M,selectedClusterId:p,selectedPointIndex:c,onClusterSelect:t,onReset:a})})]})};export{Z as default};
